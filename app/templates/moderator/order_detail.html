{% extends 'base.html' %}
{% block title %}Заказ #{{ order.id }}{% endblock %}

{% block content %}
<h2>Заказ №{{ order.id }}</h2>

<p>
  <strong>Текущий статус:</strong>
  <span id="currentStatus">{{ order.status.value }}</span>
</p>

<div class="input-group mb-3">
  <select id="statusSelect" class="form-select">
    {% for value,name in status_form.status.choices %}
      <option value="{{ value }}"
        {% if value == order.status.name %}selected{% endif %}
      >{{ name }}</option>
    {% endfor %}
  </select>
  <button id="statusBtn" class="btn btn-outline-primary" type="button">
    Обновить статус
  </button>
</div>

<div id="statusAlert"></div>

<hr>
<h3>Чат с покупателем</h3>
<div class="mb-4">
  {% for msg in chats %}
    <div class="mb-2">
      <small class="text-muted">
        {{ msg.author.username }} —
        {{ msg.created_at.strftime('%d.%m.%Y %H:%M') }}
      </small><br>
      <p>{{ msg.message }}</p>
    </div>
  {% endfor %}
</div>

<form method="post">
  {{ chat_form.hidden_tag() }}
  <div class="mb-3">
    {{ chat_form.message(class="form-control", rows=3) }}
  </div>
  <button class="btn btn-primary" type="submit" name="chat-submit">
    {{ chat_form.submit.label.text }}
  </button>
</form>

<p class="mt-4">
  <a href="{{ url_for('moderator.orders') }}">← Назад к списку заказов</a>
</p>
{% endblock %}
{% block scripts %}
  <script>
    document.getElementById('statusBtn').addEventListener('click', async () => {
      const select = document.getElementById('statusSelect');
      const newStatus = select.value;
      const alertDiv = document.getElementById('statusAlert');

      try {
        const res = await fetch(
          "{{ url_for('moderator.order_change_status', order_id=order.id) }}",
          {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({status: newStatus})
          }
        );
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Unknown');

        document.getElementById('currentStatus').textContent = data.new_status;
        alertDiv.innerHTML = '<div class="alert alert-success">Статус обновлён</div>';
      } catch (err) {
        console.error(err);
        alertDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + err + '</div>';
      }
    });
  </script>
{% endblock %}